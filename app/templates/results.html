{% extends "_base.html" %}

{% block title %}Results â€” TerrorReco{% endblock %}

{% block content %}
<div class="container" style="padding-top:32px">
  <a href="/" class="back-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 0 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd"/></svg>
    Back
  </a>

  <div class="results-header">
    <h1 class="page-title">Recommendations</h1>
    <p class="results-mood">for <em>"{{ mood }}"</em> {% if strategy_label %}<span class="results-strategy">via {{ strategy_label }}</span>{% endif %}</p>
  </div>

  {% if movies %}
  <ul class="grid">
    {% for m in movies %}
    <li class="card" onclick="openDetail({{ loop.index0 }})" role="button" tabindex="0">
      {% if m.poster_url and m.poster_url != 'N/A' %}
      <img class="card-poster" src="{{ m.poster_url }}" alt="{{ m.title }}" loading="lazy">
      {% else %}
      <div class="card-no-poster">ðŸŽ¬</div>
      {% endif %}
      <div class="card-body">
        <h2 class="card-title">{{ m.title }}</h2>
        <p class="card-meta">
          {% if m.vote_average %}<span class="rating">â˜… {{ m.vote_average }}</span>{% endif %}
          {% if m.release_date %}<span>{{ m.release_date }}</span>{% endif %}
        </p>
        {% if m.overview %}
        <p class="card-overview">{{ m.overview }}</p>
        {% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ðŸ‘»</div>
    <p>No movies found for that mood. Try a different vibe!</p>
  </div>
  {% endif %}
</div>

{# ---- Movie detail modal ---- #}
<div class="modal-overlay" id="movie-modal" onclick="closeDetail(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeDetail()" aria-label="Close">&times;</button>
    <div class="modal-layout">
      <div class="modal-poster-wrap">
        <img class="modal-poster" id="modal-poster" src="" alt="">
        <div class="modal-no-poster" id="modal-no-poster">ðŸŽ¬</div>
      </div>
      <div class="modal-info">
        <h2 class="modal-title" id="modal-title"></h2>

        <div class="modal-badges" id="modal-badges"></div>

        <div class="modal-meta-grid" id="modal-meta"></div>

        <p class="modal-plot" id="modal-plot"></p>

        <div class="modal-feedback" id="modal-feedback"></div>

        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var MOVIES = [
  {% for m in movies %}
  {
    title: {{ m.title | tojson }},
    overview: {{ (m.overview or "") | tojson }},
    poster_url: {{ (m.poster_url or "") | tojson }},
    imdb_id: {{ (m.imdb_id or "") | tojson }},
    release_date: {{ (m.release_date or "") | tojson }},
    year: {{ (m.year or "") | tojson }},
    vote_average: {{ (m.vote_average or "") | tojson }},
    genre: {{ (m.genre or "") | tojson }},
    director: {{ (m.director or "") | tojson }},
    actors: {{ (m.actors or "") | tojson }},
    writer: {{ (m.writer or "") | tojson }},
    runtime: {{ (m.runtime or "") | tojson }},
    language: {{ (m.language or "") | tojson }},
    country: {{ (m.country or "") | tojson }},
    rated: {{ (m.rated or "") | tojson }},
    awards: {{ (m.awards or "") | tojson }}
  }{{ "," if not loop.last }}
  {% endfor %}
];

var IS_LOGGED_IN = {{ "true" if user else "false" }};
var MOOD = {{ mood | tojson }};
var STRATEGY = {{ strategy | tojson }};

// Track feedback state client-side (seeded from server for logged-in users)
var feedbackState = {{ user_feedback | tojson }};
var _currentIdx = null;

function openDetail(idx){
  _currentIdx = idx;
  var m = MOVIES[idx];
  if(!m) return;

  var modal = document.getElementById('movie-modal');
  var poster = document.getElementById('modal-poster');
  var noPoster = document.getElementById('modal-no-poster');

  document.getElementById('modal-title').textContent = m.title;

  if(m.poster_url && m.poster_url !== 'N/A'){
    poster.src = m.poster_url;
    poster.alt = m.title;
    poster.style.display = 'block';
    noPoster.style.display = 'none';
  } else {
    poster.style.display = 'none';
    noPoster.style.display = 'flex';
  }

  var badges = '';
  if(m.vote_average) badges += '<span class="modal-badge rating-badge">&#9733; '+m.vote_average+'</span>';
  if(m.year) badges += '<span class="modal-badge">'+m.year+'</span>';
  if(m.runtime) badges += '<span class="modal-badge">'+m.runtime+'</span>';
  if(m.rated) badges += '<span class="modal-badge rated-badge">'+m.rated+'</span>';
  document.getElementById('modal-badges').innerHTML = badges;

  var meta = '';
  if(m.director) meta += '<div class="modal-meta-item"><span class="meta-label">Director</span><span class="meta-value">'+m.director+'</span></div>';
  if(m.actors) meta += '<div class="modal-meta-item"><span class="meta-label">Cast</span><span class="meta-value">'+m.actors+'</span></div>';
  if(m.writer) meta += '<div class="modal-meta-item"><span class="meta-label">Writer</span><span class="meta-value">'+m.writer+'</span></div>';
  if(m.genre) meta += '<div class="modal-meta-item"><span class="meta-label">Genre</span><span class="meta-value">'+m.genre+'</span></div>';
  if(m.language) meta += '<div class="modal-meta-item"><span class="meta-label">Language</span><span class="meta-value">'+m.language+'</span></div>';
  if(m.country) meta += '<div class="modal-meta-item"><span class="meta-label">Country</span><span class="meta-value">'+m.country+'</span></div>';
  if(m.awards) meta += '<div class="modal-meta-item"><span class="meta-label">Awards</span><span class="meta-value">'+m.awards+'</span></div>';
  document.getElementById('modal-meta').innerHTML = meta;

  document.getElementById('modal-plot').textContent = m.overview || 'No plot available.';

  // Feedback buttons
  renderFeedback(m.imdb_id);

  // Actions (IMDb link)
  var actions = '';
  if(m.imdb_id){
    actions += '<a href="https://www.imdb.com/title/'+m.imdb_id+'/" target="_blank" rel="noopener" class="btn btn-imdb">';
    actions += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 0 0 1.06.053L16.5 4.44v2.81a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.553l-9.056 8.194a.75.75 0 0 0-.053 1.06Z" clip-rule="evenodd"/></svg>';
    actions += 'View on IMDb</a>';
  }
  document.getElementById('modal-actions').innerHTML = actions;

  modal.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function renderFeedback(imdbId){
  var el = document.getElementById('modal-feedback');
  if(!IS_LOGGED_IN || !imdbId){
    el.innerHTML = IS_LOGGED_IN ? '' : '<p class="feedback-hint">Sign in to rate movies</p>';
    return;
  }
  var current = feedbackState[imdbId] || 0;
  el.innerHTML =
    '<span class="feedback-label">Rate this recommendation</span>' +
    '<div class="feedback-btns">' +
      '<button class="fb-btn fb-like'+(current===1?' active':'')+'" onclick="sendFeedback(\''+imdbId+'\',1)" title="Like">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3c-.91 0-1.72.54-2.08 1.34L7.13 8H5.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h8.83a1.5 1.5 0 0 0 1.46-1.16l1.2-5A1.5 1.5 0 0 0 15.53 8H12V4.5A1.5 1.5 0 0 0 10.5 3H11Z"/></svg>' +
      '</button>' +
      '<button class="fb-btn fb-dislike'+(current===-1?' active':'')+'" onclick="sendFeedback(\''+imdbId+'\',-1)" title="Dislike">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path d="M19 11.75a1.25 1.25 0 1 1-2.5 0v-7.5a1.25 1.25 0 0 1 2.5 0v7.5ZM9 17c.91 0 1.72-.54 2.08-1.34L12.87 12h1.63a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5H5.67a1.5 1.5 0 0 0-1.46 1.16l-1.2 5A1.5 1.5 0 0 0 4.47 12H8v3.5A1.5 1.5 0 0 0 9.5 17H9Z"/></svg>' +
      '</button>' +
    '</div>';
}

function sendFeedback(imdbId, rating){
  var m = MOVIES[_currentIdx];
  fetch('/api/feedback', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      imdb_id: imdbId,
      title: m ? m.title : '',
      rating: rating,
      mood: MOOD,
      strategy: STRATEGY
    })
  })
  .then(function(r){ return r.json(); })
  .then(function(data){
    feedbackState[imdbId] = data.rating;
    renderFeedback(imdbId);
    // Update card overlay indicator
    updateCardIndicator(imdbId, data.rating);
  })
  .catch(function(err){ console.error('Feedback error:', err); });
}

function updateCardIndicator(imdbId, rating){
  // Find the card index for this movie and update a small indicator
  for(var i=0; i<MOVIES.length; i++){
    if(MOVIES[i].imdb_id === imdbId){
      var card = document.querySelectorAll('.card')[i];
      if(!card) return;
      var old = card.querySelector('.card-feedback-indicator');
      if(old) old.remove();
      if(rating === 0) return;
      var ind = document.createElement('div');
      ind.className = 'card-feedback-indicator ' + (rating === 1 ? 'liked' : 'disliked');
      ind.textContent = rating === 1 ? '\u25B2' : '\u25BC';
      card.appendChild(ind);
    }
  }
}

// On load, set indicators for existing feedback
document.addEventListener('DOMContentLoaded', function(){
  for(var id in feedbackState){
    if(feedbackState[id] !== 0) updateCardIndicator(id, feedbackState[id]);
  }
});

function closeDetail(e){
  if(e && e.target !== document.getElementById('movie-modal')) return;
  document.getElementById('movie-modal').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e){
  if(e.key === 'Escape') closeDetail();
});
</script>
{% endblock %}
